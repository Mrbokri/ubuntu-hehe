name: Alpine-XFCE-RDP-Fast
on:
  workflow_dispatch:
    inputs:
      auth:
        description: 'GRDP Authorization Code'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest   # GitHub requires a host runner; weâ€™ll run Alpine in a container
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Run Alpine container
        run: |
          docker pull alpine:latest
          docker run -d --name alpine-gui --privileged --shm-size=2g -v /tmp/.X11-unix:/tmp/.X11-unix alpine:latest tail -f /dev/null

      - name: Install XFCE4, RDP, and essentials
        run: |
          docker exec alpine-gui sh -c "
            apk update && apk add --no-cache xfce4 xfce4-terminal xrdp sudo bash nano wget curl coreutils dbus unzip
          "

      - name: Add user
        run: |
          docker exec alpine-gui sh -c "
            adduser -D user && echo 'user:preetygoodpassword' | chpasswd && addgroup user wheel
          "

      - name: Configure XFCE for RDP
        run: |
          docker exec alpine-gui sh -c "
            mkdir -p /home/user/.xsession
            echo 'xfce4-session' > /home/user/.xsession
            chown user:user /home/user/.xsession
          "

      - name: Start xrdp server
        run: |
          docker exec -d alpine-gui sh -c "
            /usr/sbin/xrdp-sesman &
            /usr/sbin/xrdp -nodaemon &
          "

      - name: Install Brave browser (minimal)
        run: |
          docker exec alpine-gui sh -c "
            wget -qO - https://brave-browser-apt-release.s3.brave.com/brave-core.asc | gpg --import -
            echo 'https://brave-browser-apt-release.s3.brave.com/ stable main' >> /etc/apk/repositories
            apk update && apk add brave || true
          "

      - name: Install Telegram Desktop (minimal)
        run: |
          docker exec alpine-gui sh -c "
            wget https://telegram.org/dl/desktop/linux -O telegram.tar.xz
            tar -xvf telegram.tar.xz -C /opt/
            ln -s /opt/Telegram/Telegram /usr/local/bin/telegram || true
          "

      - name: Generate setup script
        run: |
          docker exec alpine-gui sh -c "
            touch setup.sh
            echo '${{ github.event.inputs.auth }}' >> setup.sh
            chmod 777 setup.sh
          "

      - name: Initialize GRDP
        run: |
          docker exec alpine-gui expect -c '
          spawn ./setup.sh
          expect "Enter a PIN of at least six digits: "
          send "123456\r"
          expect "Enter the same PIN again: "
          send "123456\r"
          expect eof
          '

      - name: Run custom script
        run: |
          docker exec alpine-gui sh -c "
            wget https://raw.githubusercontent.com/Mrbokri/ubuntu-hehe/main/hehe.sh
            bash hehe.sh
          "

      - name: Keep session alive
        run: |
          docker exec -d alpine-gui sh -c "while true; do sleep 60; done"
