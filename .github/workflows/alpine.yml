name: Alpine-XFCE-RDP
on:
  workflow_dispatch:
    inputs:
      ngrok_token:
        description: 'Ngrok Auth Token'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Alpine container
        run: |
          docker pull alpine:latest
          docker run -d --name alpine-gui --privileged --shm-size=2g -v /tmp/.X11-unix:/tmp/.X11-unix alpine:latest tail -f /dev/null

      - name: Install XFCE4, xrdp, and essentials
        run: |
          docker exec alpine-gui sh -c "
            apk update && apk add --no-cache xfce4 xfce4-terminal dbus-x11 xrdp sudo bash nano wget unzip
          "

      - name: Add user
        run: |
          docker exec alpine-gui sh -c "
            adduser -D user && echo 'user:preetygoodpassword' | chpasswd && addgroup user wheel
          "

      - name: Configure XFCE for RDP
        run: |
          docker exec alpine-gui sh -c "
            mkdir -p /home/user/.xsession
            echo 'xfce4-session' > /home/user/.xsession
            chown user:user /home/user/.xsession
          "

      - name: Start xrdp server
        run: |
          docker exec -d alpine-gui sh -c "
            /usr/sbin/xrdp-sesman &
            /usr/sbin/xrdp -nodaemon &
          "

      - name: Install Ngrok v3
        run: |
          docker exec alpine-gui sh -c "
            wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
            tar -xvzf ngrok-v3-stable-linux-amd64.tgz
            mv ngrok /usr/local/bin/
          "

      - name: Start Ngrok tunnel and print output
        run: |
          docker exec -d alpine-gui sh -c "
            ngrok authtoken ${{ github.event.inputs.ngrok_token }}
            ngrok tcp 3389 --region=us --log=stdout > /tmp/ngrok.log &
          "
          sleep 5
          echo "ðŸŸ¢ Ngrok output:"
          docker exec alpine-gui sh -c "cat /tmp/ngrok.log"

      - name: Keep session alive
        run: |
          docker exec -d alpine-gui sh -c "while true; do sleep 60; done"
